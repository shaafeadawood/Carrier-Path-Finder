# Career Path Finder - Supabase Setup Guide

This guide will help you set up the Supabase database requirements for the Career Path Finder application.

## Prerequisites

1. Supabase account (https://supabase.com)
2. Supabase project created
3. Python environment with the necessary packages installed

## Setup Steps

### 1. Configure Environment Variables

Create a `.env` file in the root directory of the project by copying `.env.example`:

```bash
cp .env.example .env
```

Update the `.env` file with your Supabase credentials:

```
SUPABASE_URL=https://your-project-url.supabase.co
SUPABASE_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-role-key
```

### 2. Run the Database Setup Script

This script will create the necessary tables in your Supabase project:

```bash
python setup_database.py
```

The script will:

1. Connect to your Supabase project
2. Check if the `profiles` table exists
3. Create the `profiles` table if it doesn't exist
4. Set up Row Level Security policies for the table

### 3. Manual Setup (if needed)

If the automatic setup fails, you can manually create the tables by running the SQL script that is generated by the setup script. The script will be saved as `setup_supabase_tables.sql`.

To run this script manually:

1. Go to your Supabase project dashboard
2. Click on "SQL Editor"
3. Create a new query
4. Paste the contents of `setup_supabase_tables.sql`
5. Click "Run"

## Required Tables

The application requires the following tables:

### 1. profiles

This table stores user profile information including personal details, education, experience, and skills.

```sql
-- Create profiles table
CREATE TABLE IF NOT EXISTS profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT,
  email TEXT UNIQUE,
  education TEXT,
  experience TEXT,
  projects TEXT,
  interests TEXT,
  skills TEXT[],
  career_goal TEXT,
  level TEXT,
  is_onboarded BOOLEAN DEFAULT false,
  profile_complete BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Add RLS policies
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Allow users to read their own profile
CREATE POLICY "Users can read their own profile"
  ON public.profiles
  FOR SELECT
  USING (auth.uid() = id);

-- Allow users to update their own profile
CREATE POLICY "Users can update their own profile"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = id);

-- Allow users to insert their own profile
CREATE POLICY "Users can insert their own profile"
  ON public.profiles
  FOR INSERT
  WITH CHECK (auth.uid() = id);

-- Create a public function to handle new user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, name, email)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name', NEW.email);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger the function on user signup
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### 2. roadmaps

This table stores career path recommendations for users.

```sql
-- Create roadmaps table to store career path recommendations
CREATE TABLE IF NOT EXISTS roadmaps (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  roadmap_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Add RLS policies
ALTER TABLE public.roadmaps ENABLE ROW LEVEL SECURITY;

-- Allow users to read their own roadmaps
CREATE POLICY "Users can read their own roadmaps"
  ON public.roadmaps
  FOR SELECT
  USING (auth.uid() = user_id);

-- Allow users to insert their own roadmaps
CREATE POLICY "Users can insert their own roadmaps"
  ON public.roadmaps
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);
```

### 3. users (Optional)

This table stores basic user information. Note that this is generally not needed as Supabase already has an auth.users table.

```sql
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY,
  name TEXT,
  email TEXT UNIQUE,
  profile_data JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

## Authentication Setup

The application uses Supabase Auth for user authentication. Make sure you have the following settings in your Supabase project:

1. Enable Email/Password sign-up in the Auth settings
2. Configure the Site URL and Redirect URLs to match your frontend URL
3. Set up the Auth callback URL to point to your frontend application

## Troubleshooting

### Table Not Found Errors

If you encounter the error "Could not find the table 'public.profiles' in the schema cache", it means the `profiles` table doesn't exist in your Supabase project. Run the setup script as described above to create it.

To check if your tables exist:
1. Go to your Supabase dashboard
2. Click on "Table Editor" in the left sidebar
3. See if `profiles` and other required tables are listed

### Authentication Issues

If you see authentication-related issues, make sure:
1. Your Supabase URL and API keys are correct in both your frontend `.env` and backend `.env` files
2. Your frontend application is correctly configured to use Supabase Auth
3. CORS settings in your Supabase project allow requests from your frontend URL

### Working Without Supabase

The application has been modified to work even without a Supabase connection, storing data in localStorage as a fallback. This is useful for development or testing without setting up the full infrastructure.

To use the application in this mode:
1. The CV parser will work normally as it doesn't require Supabase
2. User profiles will be saved to localStorage instead of the database
3. Some advanced features like career path recommendations might be limited

This allows you to test the core functionality while you set up your Supabase project properly.